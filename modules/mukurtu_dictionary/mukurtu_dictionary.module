<?php

use Drupal\Core\Access\AccessResult;
use Drupal\Core\Session\AccountInterface;
use Drupal\Core\Entity\EntityInterface;
use Drupal\core\Entity\EntityTypeInterface;
use Drupal\Core\Field\FieldStorageDefinitionInterface;
use Drupal\mukurtu_core\BaseFieldDefinition;
use Drupal\mukurtu_dictionary\Entity\DictionaryWord;
use Drupal\mukurtu_dictionary\Entity\DictionaryWordEntry;
use Drupal\mukurtu_dictionary\Entity\SampleSentence;
use Drupal\mukurtu_dictionary\Entity\WordList;
use Drupal\Core\Form\FormStateInterface;
use Drupal\views\ViewExecutable;

/**
 * Implements hook_theme().
 */
function mukurtu_dictionary_theme($existing, $type, $theme, $path) {
  return [
    'mukurtu_dictionary_page' => [
      'variables' => [
        'results' => NULL,
        'facets' => [],
        'glossary' => NULL,
      ],
    ],
  ];
}

/**
 * Implements hook_views_post_execute().
 */
function mukurtu_dictionary_views_post_execute(ViewExecutable $view) {
  // Check if this view is using our custom glossary sort.
  if (!isset($view->glossary_weights) || !isset($view->glossary_field) || !isset($view->glossary_order)) {
    return;
  }

  $weights = $view->glossary_weights;
  $field = $view->glossary_field;
  $order = $view->glossary_order;

  // Get the maximum weight for unweighted entries.
  $max_weight = !empty($weights) ? max($weights) + 1 : PHP_INT_MAX;

  // Sort the results based on glossary weights.
  usort($view->result, function ($a, $b) use ($weights, $field, $order, $max_weight) {
    // Get the glossary entry value from each result row.
    $value_a = '';
    $value_b = '';

    // Try to get the field value from the search result.
    if (isset($a->_item) && method_exists($a->_item, 'getField')) {
      try {
        $field_obj = $a->_item->getField($field);
        if ($field_obj) {
          $values = $field_obj->getValues();
          $value_a = reset($values) ?: '';
        }
      }
      catch (\Exception $e) {
        // Field not available, continue with empty value.
      }
    }

    if (isset($b->_item) && method_exists($b->_item, 'getField')) {
      try {
        $field_obj = $b->_item->getField($field);
        if ($field_obj) {
          $values = $field_obj->getValues();
          $value_b = reset($values) ?: '';
        }
      }
      catch (\Exception $e) {
        // Field not available, continue with empty value.
      }
    }

    // Get weights for both values.
    $weight_a = $weights[$value_a] ?? $max_weight;
    $weight_b = $weights[$value_b] ?? $max_weight;

    // First compare by weight.
    if ($weight_a != $weight_b) {
      $comparison = $weight_a <=> $weight_b;
      return $order === 'DESC' ? -$comparison : $comparison;
    }

    // If weights are equal, use alphabetical comparison.
    return strnatcasecmp($value_a, $value_b);
  });
}

/**
 * Implements hook_entity_bundle_info_alter().
 */
function mukurtu_dictionary_entity_bundle_info_alter(array &$bundles): void {
  // Dictionary word bundle class.
  if (isset($bundles['node']['dictionary_word'])) {
    $bundles['node']['dictionary_word']['class'] = DictionaryWord::class;
  }

  // Word list bundle class.
  if (isset($bundles['node']['word_list'])) {
    $bundles['node']['word_list']['class'] = WordList::class;
  }

  // Dictionary Word Entry bundle class.
  if (isset($bundles['paragraph']['dictionary_word_entry'])) {
    $bundles['paragraph']['dictionary_word_entry']['class'] = DictionaryWordEntry::class;
  }

  // Sample sentences bundle class.
  if (isset($bundles['paragraph']['sample_sentence'])) {
    $bundles['paragraph']['sample_sentence']['class'] = SampleSentence::class;
  }
}

/**
 * Implements hook_entity_field_storage_info().
 */
function mukurtu_dictionary_entity_field_storage_info(EntityTypeInterface $entity_type){
  if ($entity_type->id() == 'paragraph') {
    $fields = SampleSentence::bundleFieldDefinitions($entity_type, 'sample_sentence', []);
    $fields += DictionaryWordEntry::bundleFieldDefinitions($entity_type, 'dictionary_word_entry', []);
    return $fields;
  }

  if ($entity_type->id() == 'node') {
    $fields = DictionaryWord::bundleFieldDefinitions($entity_type, 'dictionary_word', []);
    $fields += WordList::bundleFieldDefinitions($entity_type, 'word_list', []);
    return $fields;
  }
}

/**
 * Implements hook_entity_access().
 */
function mukurtu_dictionary_entity_access(EntityInterface $entity, $operation, AccountInterface $account) {
  if ($entity->getEntityTypeId() === 'paragraphs_type') {
    if($entity->id() === 'dictionary_word_entry' && $operation === 'delete') {
      // Don't allow the dictionary word entry paragraph type to be deleted.
      return AccessResult::forbidden();
    }
  }
}

/**
 * Implements hook_entity_bundle_field_info().
 */
function mukurtu_dictionary_entity_bundle_field_info(EntityTypeInterface $entity_type, $bundle, array $base_field_definitions) {
  if ($entity_type->id() == 'node' && $bundle == 'dictionary_word') {
    $fields = [];
    $fields['field_in_word_list'] = BaseFieldDefinition::create('entity_reference')
      ->setName('field_in_word_list')
      ->setLabel(t('Word Lists'))
      ->setDescription(t('Word lists this word is contained in.'))
      ->setComputed(TRUE)
      ->setClass('Drupal\mukurtu_dictionary\Plugin\Field\MukurtuInWordListFieldItemsList')
      ->setTargetEntityTypeId('node')
      ->setTargetBundle('word_list')
      ->setRevisionable(FALSE)
      ->setTranslatable(FALSE)
      ->setCardinality(FieldStorageDefinitionInterface::CARDINALITY_UNLIMITED)
      ->setDisplayConfigurable('view', TRUE);

    return $fields;
  }
}

/**
 * Implements hook_form_form_id_alter().
 */
function mukurtu_dictionary_form_node_dictionary_word_form_alter(&$form, FormStateInterface $form_state) {
  mukurtu_dictionary_language_field_config_helper($form, $form_state);
}

/**
 * Implements hook_form_form_id_alter().
 */
function mukurtu_dictionary_form_node_dictionary_word_edit_form_alter(&$form, FormStateInterface $form_state) {
  mukurtu_dictionary_language_field_config_helper($form, $form_state);
}

// Helper method to pull dictionary language field options from config.
function mukurtu_dictionary_language_field_config_helper(&$form, FormStateInterface $form_state) {
  $config = \Drupal::config('mukurtu_dictionary_languages.settings');
  $allowedLanguages = $config->get('available_languages');
  $languageOptions = [];
  if ($allowedLanguages) {
    foreach ($allowedLanguages as $tid => $value) {
      $term = \Drupal::entityTypeManager()->getStorage('taxonomy_term')->load($tid);
      if ($term) {
        $languageOptions[$tid] = $term->getName();
      }
    }
    // If there's only one language on the site, select it automatically.
    if (count($allowedLanguages) == 1) {
      $form['field_dictionary_word_language']['widget']['#default_value'] = array_key_first($languageOptions);
    }
    $form['field_dictionary_word_language']['widget']['#options'] = $languageOptions;
  }
}

/**
 * Implements hook_mukurtu_taxonomy_indexed_fields_alter().
 */
function mukurtu_dictionary_mukurtu_taxonomy_indexed_fields_alter(array &$allowed_fields) {
  $allowed_fields[] = 'field_dictionary_word_language';
  $allowed_fields[] = 'field_language';
  $allowed_fields[] = 'field_word_type';
}
